<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ü§ñ Telegram Bot Debug</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: #1a1a1a !important;
            color: #00ff00 !important;
            font-family: 'Courier New', monospace;
            padding: 15px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .header {
            background: #ff0000;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .section {
            background: rgba(0,255,0,0.1);
            border: 1px solid #00ff00;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .error { color: #ff4444; }
        .success { color: #44ff44; }
        .warning { color: #ffaa44; }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        
        .test-pass { border-color: #44ff44; background: rgba(68,255,68,0.1); }
        .test-fail { border-color: #ff4444; background: rgba(255,68,68,0.1); }
        .test-warn { border-color: #ffaa44; background: rgba(255,170,68,0.1); }
        
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        
        button:hover { background: #44ff44; }
        
        .log {
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="header">
        ü§ñ TELEGRAM BOT –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê
        <br>–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã —á–µ—Ä–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
    </div>

    <div class="section">
        <h3>üìä –°–ò–°–¢–ï–ú–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø</h3>
        <div id="system-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="section">
        <h3>üåê –¢–ï–°–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø</h3>
        <button onclick="testConnections()">üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã</button>
        <div id="connection-tests"></div>
    </div>

    <div class="section">
        <h3>ü§ñ TELEGRAM API –¢–ï–°–¢</h3>
        <button onclick="testTelegramAPI()">üì± –¢–µ—Å—Ç Telegram WebApp</button>
        <div id="telegram-tests"></div>
    </div>

    <div class="section">
        <h3>üìù –õ–û–ì–ò –†–ï–ê–õ–¨–ù–û–ì–û –í–†–ï–ú–ï–ù–ò</h3>
        <button onclick="startLogging()">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
        <button onclick="stopLogging()">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <div class="log" id="live-logs">–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ" –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞...</div>
    </div>

    <div class="section">
        <h3>üõ†Ô∏è –†–ï–®–ï–ù–ò–Ø –ü–†–û–ë–õ–ï–ú</h3>
        <div id="solutions"></div>
    </div>

    <script>
        let loggingInterval = null;
        let testResults = [];
        
        // –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        function displaySystemInfo() {
            const info = {
                'User-Agent': navigator.userAgent,
                '–≠–∫—Ä–∞–Ω': `${screen.width}x${screen.height}`,
                'Viewport': `${window.innerWidth}x${window.innerHeight}`,
                'URL': window.location.href,
                'Referer': document.referrer || '–ù–µ—Ç',
                '–Ø–∑—ã–∫': navigator.language,
                '–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞': navigator.platform,
                '–í—Ä–µ–º—è': new Date().toLocaleString()
            };
            
            let html = '';
            for (const [key, value] of Object.entries(info)) {
                html += `<div><strong>${key}:</strong> ${value}</div>`;
            }
            
            document.getElementById('system-info').innerHTML = html;
        }
        
        // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
        async function testConnections() {
            const tests = [
                { name: 'HTTP /app', url: '/app' },
                { name: 'HTTPS /app', url: 'https://89.169.182.9:3443/app' },
                { name: 'API Categories', url: '/products/categories' },
                { name: 'Telegram Script', url: 'https://telegram.org/js/telegram-web-app.js' }
            ];
            
            let html = '';
            
            for (const test of tests) {
                try {
                    const startTime = Date.now();
                    const response = await fetch(test.url, { 
                        method: 'HEAD',
                        mode: 'no-cors'
                    });
                    const endTime = Date.now();
                    
                    html += `<div class="test-result test-pass">
                        ‚úÖ ${test.name}: OK (${endTime - startTime}ms)
                    </div>`;
                } catch (error) {
                    html += `<div class="test-result test-fail">
                        ‚ùå ${test.name}: –û–®–ò–ë–ö–ê - ${error.message}
                    </div>`;
                }
            }
            
            document.getElementById('connection-tests').innerHTML = html;
        }
        
        // –¢–µ—Å—Ç Telegram API
        function testTelegramAPI() {
            let html = '';
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Telegram –æ–±—ä–µ–∫—Ç–∞
            if (window.Telegram) {
                html += `<div class="test-result test-pass">
                    ‚úÖ window.Telegram: –î–æ—Å—Ç—É–ø–µ–Ω
                </div>`;
                
                if (window.Telegram.WebApp) {
                    html += `<div class="test-result test-pass">
                        ‚úÖ Telegram.WebApp: –î–æ—Å—Ç—É–ø–µ–Ω
                    </div>`;
                    
                    const webApp = window.Telegram.WebApp;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–æ–π—Å—Ç–≤–∞ WebApp
                    const properties = [
                        'initData', 'initDataUnsafe', 'version', 'platform',
                        'colorScheme', 'themeParams', 'isExpanded', 'viewportHeight',
                        'viewportStableHeight', 'headerColor', 'backgroundColor'
                    ];
                    
                    properties.forEach(prop => {
                        if (webApp[prop] !== undefined) {
                            html += `<div class="test-result test-pass">
                                ‚úÖ WebApp.${prop}: ${JSON.stringify(webApp[prop]).substring(0, 100)}
                            </div>`;
                        } else {
                            html += `<div class="test-result test-warn">
                                ‚ö†Ô∏è WebApp.${prop}: –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ
                            </div>`;
                        }
                    });
                    
                } else {
                    html += `<div class="test-result test-fail">
                        ‚ùå Telegram.WebApp: –ù–ï –î–û–°–¢–£–ü–ï–ù
                    </div>`;
                }
            } else {
                html += `<div class="test-result test-fail">
                    ‚ùå window.Telegram: –ù–ï –î–û–°–¢–£–ü–ï–ù
                </div>`;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            html += `<div class="test-result ${isMobile ? 'test-pass' : 'test-warn'}">
                ${isMobile ? '‚úÖ' : '‚ö†Ô∏è'} –ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${isMobile ? '–î–ê' : '–ù–ï–¢'}
            </div>`;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
            const fromTelegram = document.referrer.includes('telegram') || 
                               window.location.href.includes('tgWebAppData');
            html += `<div class="test-result ${fromTelegram ? 'test-pass' : 'test-fail'}">
                ${fromTelegram ? '‚úÖ' : '‚ùå'} –ó–∞–ø—É—Å–∫ –∏–∑ Telegram: ${fromTelegram ? '–î–ê' : '–ù–ï–¢'}
            </div>`;
            
            document.getElementById('telegram-tests').innerHTML = html;
        }
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        function startLogging() {
            if (loggingInterval) return;
            
            const logElement = document.getElementById('live-logs');
            let logCount = 0;
            
            logElement.innerHTML = '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω...\n';
            
            loggingInterval = setInterval(async () => {
                try {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
                    const response = await fetch('/products/categories', {
                        headers: {
                            'X-Debug-Source': 'telegram-debug',
                            'X-Debug-Time': Date.now()
                        }
                    });
                    
                    logCount++;
                    const timestamp = new Date().toLocaleTimeString();
                    logElement.innerHTML += `[${timestamp}] –¢–µ—Å—Ç #${logCount}: ${response.status} ${response.statusText}\n`;
                    
                    // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
                    logElement.scrollTop = logElement.scrollHeight;
                    
                } catch (error) {
                    const timestamp = new Date().toLocaleTimeString();
                    logElement.innerHTML += `[${timestamp}] –û–®–ò–ë–ö–ê: ${error.message}\n`;
                }
            }, 3000);
        }
        
        function stopLogging() {
            if (loggingInterval) {
                clearInterval(loggingInterval);
                loggingInterval = null;
                document.getElementById('live-logs').innerHTML += '\n–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.\n';
            }
        }
        
        // –†–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º
        function displaySolutions() {
            const solutions = [
                {
                    problem: 'ü§ñ –ë–æ—Ç –Ω–µ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É',
                    solution: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤ BotFather: /setmenubutton ‚Üí https://89.169.182.9:3443/app'
                },
                {
                    problem: 'üîí SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ –≤–∞–ª–∏–¥–µ–Ω',
                    solution: 'Telegram —Ç—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π SSL. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Let\'s Encrypt –∏–ª–∏ –∫—É–ø–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç'
                },
                {
                    problem: 'üì± –ß–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω –≤ –º–æ–±–∏–ª—å–Ω–æ–º Telegram',
                    solution: '–ü—Ä–æ–±–ª–µ–º–∞ —Å iframe. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ X-Frame-Options –∏ CSP'
                },
                {
                    problem: 'üåê Mixed Content –æ—à–∏–±–∫–∏',
                    solution: '–í—Å–µ —Ä–µ—Å—É—Ä—Å—ã –¥–æ–ª–∂–Ω—ã –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –ø–æ HTTPS'
                }
            ];
            
            let html = '';
            solutions.forEach(item => {
                html += `<div class="test-result test-warn">
                    <strong>${item.problem}</strong><br>
                    üí° ${item.solution}
                </div>`;
            });
            
            document.getElementById('solutions').innerHTML = html;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            displaySystemInfo();
            displaySolutions();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
            setTimeout(() => {
                testConnections();
                testTelegramAPI();
            }, 1000);
        });
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function sendDiagnostics() {
            const diagnostics = {
                userAgent: navigator.userAgent,
                url: window.location.href,
                referrer: document.referrer,
                timestamp: Date.now(),
                telegramAvailable: !!(window.Telegram && window.Telegram.WebApp),
                testResults: testResults
            };
            
            try {
                await fetch('/debug/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(diagnostics)
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:', error);
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', sendDiagnostics);
    </script>
</body>
</html> 