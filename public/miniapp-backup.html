<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery App</title>
    <meta name="description" content="–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –µ–¥—ã">
    <meta name="theme-color" content="#ff6b35">
    
    <!-- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Delivery App">
    
    <!-- Preload –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ -->
    <link rel="preload" as="script" href="https://telegram.org/js/telegram-web-app.js">
    
    <!-- –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï CSS –°–¢–ò–õ–ò –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ß–ï–†–ù–û–ì–û –≠–ö–†–ê–ù–ê -->
    <style>
        /* –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ß–ï–†–ù–û–ì–û –≠–ö–†–ê–ù–ê */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            height: 100%;
            background-color: #ffffff !important;
            color: #000000 !important;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #ffffff !important;
            color: #000000 !important;
            min-height: 100vh !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px 16px 80px;
            min-height: 100vh;
            background-color: #ffffff !important;
            display: block !important;
            visibility: visible !important;
        }

        /* –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            color: #666;
        }

        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
        .categories {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .category-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .category-card:hover {
            transform: translateY(-2px);
        }

        .category-emoji {
            font-size: 32px;
            margin-bottom: 8px;
            display: block;
        }

        .category-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        /* –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
        .hidden {
            display: none !important;
        }

        #products-view {
            display: none;
        }

        #products-view.active {
            display: block;
        }
    </style>
    
    <script>
        // –≠–ö–°–¢–†–ï–ù–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ß–ï–†–ù–û–ì–û –≠–ö–†–ê–ù–ê
        document.documentElement.style.cssText = 'background: white !important; min-height: 100vh !important;';
        
        // –°–∏—Å—Ç–µ–º–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è console.log –≤ production
        if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
            console.log = function() {};
            console.warn = function() {};
            console.info = function() {};
            // –û—Å—Ç–∞–≤–ª—è–µ–º console.error –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
        }
        
        // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        document.addEventListener('DOMContentLoaded', function() {
            document.body.style.cssText = 'background: white !important; min-height: 100vh !important; display: block !important; visibility: visible !important; color: black !important;';
            console.log('üü¢ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, —Å—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
        });

        // –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–¢–õ–ê–î–ö–ò TELEGRAM WEBAPP
        function diagnoseWebApp() {
            console.log('=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê TELEGRAM WEBAPP ===');
            console.log('window.Telegram:', !!window.Telegram);
            console.log('window.Telegram.WebApp:', !!(window.Telegram && window.Telegram.WebApp));
            
            if (window.Telegram && window.Telegram.WebApp) {
                const webapp = window.Telegram.WebApp;
                console.log('WebApp –≤–µ—Ä—Å–∏—è:', webapp.version);
                console.log('WebApp –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞:', webapp.platform);
                console.log('WebApp isVersionAtLeast(6.1):', webapp.isVersionAtLeast('6.1'));
                
                console.log('initData:', webapp.initData || '–ù–ï–¢');
                console.log('initDataUnsafe:', webapp.initDataUnsafe || '–ù–ï–¢');
                
                if (webapp.initDataUnsafe) {
                    console.log('initDataUnsafe.user:', webapp.initDataUnsafe.user || '–ù–ï–¢');
                    console.log('initDataUnsafe.auth_date:', webapp.initDataUnsafe.auth_date || '–ù–ï–¢');
                    console.log('initDataUnsafe.start_param:', webapp.initDataUnsafe.start_param || '–ù–ï–¢');
                }
                
                if (webapp.initData) {
                    console.log('–†–∞–∑–±–æ—Ä initData:');
                    try {
                        const urlParams = new URLSearchParams(webapp.initData);
                        console.log('URLParams:', Object.fromEntries(urlParams));
                        
                        const userParam = urlParams.get('user');
                        if (userParam) {
                            const user = JSON.parse(decodeURIComponent(userParam));
                            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ initData:', user);
                        }
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ initData:', e);
                    }
                }
            }
            console.log('=== –ö–û–ù–ï–¶ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===');
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            setTimeout(diagnoseWebApp, 500);
        });

        // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        let tg = null;
        let telegramScriptLoaded = false;
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ Telegram WebApp —Å–∫—Ä–∏–ø—Ç–∞
        (function() {
            const script = document.createElement('script');
            script.src = 'https://telegram.org/js/telegram-web-app.js';
            script.onerror = function() {
                initializeFallbackTg();
            };
            script.onload = function() {
                telegramScriptLoaded = true;
                initializeTelegramWebApp();
            };
            document.head.appendChild(script);
        })();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        function initializeTelegramWebApp() {
            try {
                if (window.Telegram && window.Telegram.WebApp) {
                    tg = window.Telegram.WebApp;
                    console.log('‚úÖ Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    console.log('–í–µ—Ä—Å–∏—è WebApp:', tg.version);
                    console.log('–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:', tg.platform);
                    console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã:', !!(tg.initDataUnsafe && tg.initDataUnsafe.user));
                    
                    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                        console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram –Ω–∞–π–¥–µ–Ω:', tg.initDataUnsafe.user);
                    } else if (tg.initData) {
                        console.log('üìù initData –¥–æ—Å—Ç—É–ø–Ω—ã, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                        console.log('initData:', tg.initData);
                    } else {
                        console.warn('‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
                    }
                    
                    tg.ready();
                    tg.expand();
                    
                    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
                    if (tg.themeParams) {
                        document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
                        document.body.style.color = tg.themeParams.text_color || '#000000';
                    }
                } else {
                    throw new Error('Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ WebApp:', error);
                initializeFallbackTg();
            }
        }
        
        // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ Telegram
        function initializeFallbackTg() {
            tg = {
                ready: () => {},
                expand: () => {},
                close: () => window.history.back(),
                MainButton: {
                    setText: () => {},
                    show: () => {},
                    hide: () => {},
                    onClick: () => {}
                },
                HapticFeedback: {
                    impactOccurred: () => {}
                },
                showAlert: (message) => alert(message),
                themeParams: {
                    bg_color: '#ffffff',
                    text_color: '#000000'
                }
            };

        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let categories = [];
        let products = [];
        let cart = {};
        let currentCategory = null;
        let currentUser = null;
        let userAddresses = [];
        let userOrders = [];
        let currentView = 'categories'; // 'categories', 'products', 'profile'

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.body.style.display = 'block';
            document.body.style.visibility = 'visible';
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            initializeUser();
            
            loadCategories();
            updateCartIcon();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ Telegram (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
            setTimeout(() => {
                if (tg && tg.MainButton) {
                    tg.MainButton.setText('–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ—Ä–∑–∏–Ω—É');
                    tg.MainButton.onClick(showCart);
                }
            }, 1000);
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function initializeUser() {
            try {
                // –ü–†–ò–û–†–ò–¢–ï–¢: –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                let userData = null;
                
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram WebApp
                if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const telegramUser = tg.initDataUnsafe.user;
                    console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram:', telegramUser);
                    
                    userData = {
                        telegram_id: telegramUser.id.toString(),
                        first_name: telegramUser.first_name || '',
                        last_name: telegramUser.last_name || '',
                        username: telegramUser.username || ''
                    };
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ initData
                if (!userData && tg && tg.initData) {
                    try {
                        const urlParams = new URLSearchParams(tg.initData);
                        const userParam = urlParams.get('user');
                        if (userParam) {
                            const telegramUser = JSON.parse(decodeURIComponent(userParam));
                            console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ initData:', telegramUser);
                            
                            userData = {
                                telegram_id: telegramUser.id.toString(),
                                first_name: telegramUser.first_name || '',
                                last_name: telegramUser.last_name || '',
                                username: telegramUser.username || ''
                            };
                        }
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ initData:', e);
                    }
                }
                
                // –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ
                if (!userData) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ —Ä–µ–∂–∏–º');
                    userData = {
                        telegram_id: 'demo_user',
                        first_name: '–î–µ–º–æ',
                        last_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 
                        username: 'demo_user'
                    };
                } else {
                    console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userData.telegram_id);
                }
                
                // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                const response = await fetch('/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:', currentUser.telegram_id);
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–¥—Ä–µ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await loadUserAddresses();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞
                    if (userAddresses.length === 0) {
                        showAddressSetup();
                    }
                } else {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', response.status);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥—Ä–µ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserAddresses() {
            try {
                if (!currentUser || !currentUser.telegram_id) {
                    return;
                }
                
                const response = await fetch(`/addresses/${currentUser.telegram_id}`);
                if (response.ok) {
                    userAddresses = await response.json();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥—Ä–µ—Å–æ–≤:', response.status);
                    userAddresses = [];
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥—Ä–µ—Å–æ–≤:', error);
                userAddresses = [];
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥—Ä–µ—Å–∞
        function showAddressSetup() {
            
            const message = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –î–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞–º –Ω—É–∂–µ–Ω –≤–∞—à –∞–¥—Ä–µ—Å. –•–æ—Ç–∏—Ç–µ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –≤–∞—à–µ–º—É –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é?';
            
            if (tg && tg.showConfirm) {
                tg.showConfirm(message, (confirmed) => {
                    if (confirmed) {
                        requestGeolocation();
                    } else {
                        showManualAddressForm();
                    }
                });
            } else {
                const confirmed = confirm(message);
                if (confirmed) {
                    requestGeolocation();
                } else {
                    showManualAddressForm();
                }
            }
        }

        // –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        function requestGeolocation() {
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Telegram WebApp Location API
            if (tg && tg.LocationManager) {
                tg.LocationManager.getLocation((location) => {
                    if (location) {
                        geocodeAndSaveAddress(location.latitude, location.longitude);
                    } else {
                        fallbackToWebGeolocation();
                    }
                });
            } else {
                fallbackToWebGeolocation();
            }
        }

        // Fallback –∫ Web Geolocation API
        function fallbackToWebGeolocation() {
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        geocodeAndSaveAddress(position.coords.latitude, position.coords.longitude);
                    },
                    (error) => {
                        console.error(' –û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
                        showManualAddressForm();
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            } else {
                showManualAddressForm();
            }
        }

        // –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
        async function geocodeAndSaveAddress(latitude, longitude) {
            try {
                
                // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                const response = await fetch('/addresses/geocode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude, longitude })
                });
                
                if (response.ok) {
                    const addressData = await response.json();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞
                    showAddressConfirmation(addressData);
                } else {
                    console.error(' –û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', response.status);
                    showManualAddressForm();
                }
            } catch (error) {
                console.error(' –û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                showManualAddressForm();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
        function showAddressConfirmation(addressData) {
            const message = `–ú—ã –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ –≤–∞—à –∞–¥—Ä–µ—Å –∫–∞–∫:\n\n${addressData.full_address}\n\n–í—Å—ë –≤–µ—Ä–Ω–æ?`;
            
            if (tg && tg.showConfirm) {
                tg.showConfirm(message, (confirmed) => {
                    if (confirmed) {
                        saveAddress(addressData, '–û—Å–Ω–æ–≤–Ω–æ–π –∞–¥—Ä–µ—Å');
                    } else {
                        showManualAddressForm(addressData);
                    }
                });
            } else {
                const confirmed = confirm(message);
                if (confirmed) {
                    saveAddress(addressData, '–û—Å–Ω–æ–≤–Ω–æ–π –∞–¥—Ä–µ—Å');
                } else {
                    showManualAddressForm(addressData);
                }
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–∞
        function showManualAddressForm(prefillData = null) {
            
            // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ prompt
            const address = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∞–¥—Ä–µ—Å:', prefillData ? prefillData.full_address : '');
            
            if (address && address.trim()) {
                const addressData = {
                    full_address: address.trim(),
                    latitude: prefillData ? prefillData.latitude : null,
                    longitude: prefillData ? prefillData.longitude : null
                };
                
                saveAddress(addressData, '–û—Å–Ω–æ–≤–Ω–æ–π –∞–¥—Ä–µ—Å');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–¥—Ä–µ—Å
        async function saveAddress(addressData, addressName) {
            try {
                
                const addressToSave = {
                    telegram_id: currentUser.telegram_id,
                    name: addressName,
                    latitude: addressData.latitude,
                    longitude: addressData.longitude,
                    full_address: addressData.full_address,
                    entrance: '',
                    floor: '',
                    apartment: '',
                    intercom: '',
                    comment: '',
                    is_default: true
                };
                
                const response = await fetch('/addresses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(addressToSave)
                });
                
                if (response.ok) {
                    const savedAddress = await response.json();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤
                    await loadUserAddresses();
                    
                    if (tg && tg.showAlert) {
                        tg.showAlert('–ê–¥—Ä–µ—Å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                    } else {
                        alert('–ê–¥—Ä–µ—Å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                    }
                } else {
                    console.error(' –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞:', response.status);
                    if (tg && tg.showAlert) {
                        tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞');
                    } else {
                        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞');
                    }
                }
            } catch (error) {
                console.error(' –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞');
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞');
                }
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        async function loadCategories() {
            try {
                const response = await fetch('/products/categories');
                categories = await response.json();
                displayCategories();
            } catch (error) {
                console.error(' –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
                document.getElementById('categories-list').innerHTML = '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>';
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function displayCategories() {
            const container = document.getElementById('categories-list');
            const emojis = {
                '–ú–æ—Ä–æ–∂–µ–Ω–Ω–æ–µ': 'üç¶',
                '–ü–µ–ª—å–º–µ–Ω–∏': 'ü•ü',
                '–ë—É—Ä–≥–µ—Ä—ã': 'üçî',
                '–ü–∏—Ü—Ü–∞': 'üçï',
                '–°—É—à–∏': 'üç±',
                '–ù–∞–ø–∏—Ç–∫–∏': 'ü•§',
                '–î–µ—Å–µ—Ä—Ç—ã': 'üç∞',
                '–°–∞–ª–∞—Ç—ã': 'ü•ó'
            };

            container.innerHTML = categories.map(category => `
                <div class="category-card" onclick="showProducts(${category.id})">
                    <span class="category-emoji">${category.emoji || emojis[category.name] || 'üçΩÔ∏è'}</span>
                    <div class="category-name">${category.name}</div>
                </div>
            `).join('');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        async function showProducts(categoryId) {
            currentCategory = categoryId;
            try {
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                const container = document.getElementById('products-list');
                container.innerHTML = `
                    <div class="loading" style="grid-column: 1 / -1;">
                        <div style="font-size: 24px; margin-bottom: 8px;">‚è≥</div>
                        –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...
                    </div>
                `;
                
                const response = await fetch(`/products/category/${categoryId}`);
                products = await response.json();
                displayProducts();
                
                document.getElementById('categories-view').style.display = 'none';
                document.getElementById('products-view').classList.add('active');
            } catch (error) {
                console.error(' –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
                const container = document.getElementById('products-list');
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">‚ùå</div>
                        <div class="empty-state-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                        <div class="empty-state-description">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.</div>
                    </div>
                `;
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
        function displayProducts() {
            const container = document.getElementById('products-list');
            
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üõí</div>
                        <div class="empty-state-title">–ü–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</div>
                        <div class="empty-state-description">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä—ã —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è!</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = products.map(product => {
                const cartQuantity = cart[product.id] ? cart[product.id].quantity : 0;
                const hasInCart = cartQuantity > 0;
                
                return `
                    <div class="product-card" data-product-id="${product.id}">
                        <div class="product-image">
                            ${product.image ? 
                                `<img src="${product.image}" alt="${product.name}" loading="lazy">` : 
                                '<div style="color: #bbb; font-size: 24px;">üì¶</div>'
                            }
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            ${product.description ? `<div class="product-description">${product.description}</div>` : ''}
                            ${product.weight ? `<div class="product-weight">${product.weight}</div>` : ''}
                            <div class="product-price">${product.price} ‚ÇΩ</div>
                            <div class="product-actions">
                                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫–æ–≥–¥–∞ —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω–µ) -->
                                <div class="quantity-controls ${hasInCart ? 'active' : ''}" id="quantity-${product.id}">
                                    <button class="quantity-btn" onclick="decreaseQuantity(${product.id})" ${cartQuantity <= 1 ? 'data-remove="true"' : ''}>
                                        ${cartQuantity <= 1 ? 'üóëÔ∏è' : '‚àí'}
                                    </button>
                                    <span class="quantity-display" id="quantity-display-${product.id}">${cartQuantity}</span>
                                    <button class="quantity-btn" onclick="increaseQuantity(${product.id})">+</button>
                                </div>
                                
                                <!-- –ö–Ω–æ–ø–∫–∞ "–í –∫–æ—Ä–∑–∏–Ω—É" (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç –≤ –∫–æ—Ä–∑–∏–Ω–µ) -->
                                <button class="add-to-cart-btn ${hasInCart ? 'hidden' : ''}" 
                                        id="add-btn-${product.id}" 
                                        onclick="addToCart(${product.id})">
                                    –í –∫–æ—Ä–∑–∏–Ω—É
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function showCategories() {
            document.getElementById('products-view').classList.remove('active');
            document.getElementById('categories-view').style.display = 'block';
        }

        // –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            if (cart[productId]) {
                cart[productId].quantity += 1;
            } else {
                cart[productId] = {
                    ...product,
                    quantity: 1
                };
            }

            updateCartIcon();
            updateProductUI(productId);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            const productCard = document.querySelector(`[data-product-id="${productId}"]`);
            if (productCard) {
                productCard.classList.add('adding');
                setTimeout(() => {
                    productCard.classList.remove('adding');
                }, 300);
            }
            
            // –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }

        // –£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞
        function increaseQuantity(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            if (cart[productId]) {
                cart[productId].quantity += 1;
            } else {
                cart[productId] = {
                    ...product,
                    quantity: 1
                };
            }

            updateCartIcon();
            updateProductUI(productId);
            
            // –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }

        // –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞
        function decreaseQuantity(productId) {
            if (!cart[productId]) return;

            if (cart[productId].quantity > 1) {
                cart[productId].quantity -= 1;
            } else {
                // –£–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
                delete cart[productId];
            }

            updateCartIcon();
            updateProductUI(productId);
            
            // –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Ç–æ–≤–∞—Ä–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        function updateProductUI(productId) {
            const cartQuantity = cart[productId] ? cart[productId].quantity : 0;
            const hasInCart = cartQuantity > 0;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã UI
            const quantityControls = document.getElementById(`quantity-${productId}`);
            const quantityDisplay = document.getElementById(`quantity-display-${productId}`);
            const addButton = document.getElementById(`add-btn-${productId}`);
            
            if (quantityControls && quantityDisplay && addButton) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                if (hasInCart) {
                    quantityControls.classList.add('active');
                    addButton.classList.add('hidden');
                    quantityDisplay.textContent = cartQuantity;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–º–µ–Ω—å—à–µ–Ω–∏—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ = 1)
                    const decreaseBtn = quantityControls.querySelector('.quantity-btn');
                    if (cartQuantity <= 1) {
                        decreaseBtn.innerHTML = 'üóëÔ∏è';
                        decreaseBtn.setAttribute('data-remove', 'true');
                    } else {
                        decreaseBtn.innerHTML = '‚àí';
                        decreaseBtn.removeAttribute('data-remove');
                    }
                } else {
                    quantityControls.classList.remove('active');
                    addButton.classList.remove('hidden');
                }
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å UI –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
        function updateAllProductsUI() {
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏—Ö UI
            products.forEach(product => {
                updateProductUI(product.id);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
        function updateCartIcon() {
            const totalItems = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
            const countElement = document.getElementById('cart-count');
            
            if (totalItems > 0) {
                countElement.textContent = totalItems;
                countElement.style.display = 'flex';
                if (tg && tg.MainButton) {
                    const totalPrice = Object.values(cart).reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    tg.MainButton.setText(`–ö–æ—Ä–∑–∏–Ω–∞ ‚Ä¢ ${totalPrice} ‚ÇΩ`);
                    tg.MainButton.show();
                }
            } else {
                countElement.style.display = 'none';
                if (tg && tg.MainButton) {
                    tg.MainButton.hide();
                }
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É
        function showCart() {
            const modal = document.getElementById('cart-modal');
            const itemsContainer = document.getElementById('cart-items');
            const totalContainer = document.getElementById('cart-total');
            
            const cartItems = Object.values(cart);
            
            if (cartItems.length === 0) {
                itemsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';
                totalContainer.textContent = '–ò—Ç–æ–≥–æ: 0 ‚ÇΩ';
            } else {
                itemsContainer.innerHTML = cartItems.map(item => `
                    <div class="cart-item">
                        <div>
                            <div style="font-weight: 600;">${item.name}</div>
                            <div style="color: #999; font-size: 14px;">${item.price} ‚ÇΩ √ó ${item.quantity}</div>
                        </div>
                        <div style="font-weight: 600;">${item.price * item.quantity} ‚ÇΩ</div>
                    </div>
                `).join('');
                
                const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                totalContainer.textContent = `–ò—Ç–æ–≥–æ: ${total} ‚ÇΩ`;
            }
            
            modal.classList.add('active');
        }

        // –ó–∞–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É
        function closeCart() {
            document.getElementById('cart-modal').classList.remove('active');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞
        function showProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const message = `${product.name}\n\n${product.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}\n\n–¶–µ–Ω–∞: ${product.price} ‚ÇΩ`;
            
            if (tg && tg.showAlert) {
                tg.showAlert(message);
            } else {
                alert(message);
            }
        }

        // –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
        async function checkout() {
            const cartItems = Object.values(cart);
            if (cartItems.length === 0) {
                if (tg && tg.showAlert) {
                    tg.showAlert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');
                } else {
                    alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');
                }
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –∞–¥—Ä–µ—Å
            if (!currentUser) {
                if (tg && tg.showAlert) {
                    tg.showAlert('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
                } else {
                    alert('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
                }
                return;
            }
            
            if (userAddresses.length === 0) {
                if (tg && tg.showAlert) {
                    tg.showAlert('–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏.');
                } else {
                    alert('–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏.');
                }
                showAddressSetup();
                return;
            }
            
            try {
                const defaultAddress = userAddresses.find(addr => addr.is_default) || userAddresses[0];
                
                const orderData = {
                    user_id: currentUser.id,
                    telegram_id: currentUser.telegram_id,
                    items: cartItems,
                    total: cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    address: defaultAddress.full_address,
                    address_details: {
                        id: defaultAddress.id,
                        name: defaultAddress.name,
                        entrance: defaultAddress.entrance,
                        floor: defaultAddress.floor,
                        apartment: defaultAddress.apartment,
                        intercom: defaultAddress.intercom,
                        comment: defaultAddress.comment
                    },
                    timestamp: new Date().toISOString()
                };
                
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await fetch('/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    const order = await response.json();
                    
                    // –û—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
                    cart = {};
                    updateCartIcon();
                    closeCart();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤
                    updateAllProductsUI();
                    
                    if (tg && tg.showAlert) {
                        tg.showAlert(`–ó–∞–∫–∞–∑ #${order.id} –æ—Ñ–æ—Ä–º–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!`);
                    } else {
                        alert(`–ó–∞–∫–∞–∑ #${order.id} –æ—Ñ–æ—Ä–º–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!`);
                    }
                } else {
                    console.error(' –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞:', response.status);
                    if (tg && tg.showAlert) {
                        tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                    } else {
                        alert('–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                    }
                }
                
            } catch (error) {
                console.error(' –û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                }
            }
        }

        // ===============================
        // –§–£–ù–ö–¶–ò–ò –ù–ê–í–ò–ì–ê–¶–ò–ò
        // ===============================

        function showCatalog() {
            currentView = 'categories';
            hideAllViews();
            document.getElementById('categories-view').style.display = 'block';
            setActiveNavItem('nav-catalog');
        }

        function showProfile() {
            currentView = 'profile';
            hideAllViews();
            document.getElementById('profile-view').classList.add('active');
            setActiveNavItem('nav-profile');
            loadProfileData();
        }

        function hideAllViews() {
            document.getElementById('categories-view').style.display = 'none';
            document.getElementById('products-view').classList.remove('active');
            document.getElementById('profile-view').classList.remove('active');
        }

        function setActiveNavItem(activeId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(activeId).classList.add('active');
        }

        // ===============================
        // –§–£–ù–ö–¶–ò–ò –õ–ò–ß–ù–û–ì–û –ö–ê–ë–ò–ù–ï–¢–ê
        // ===============================

        async function loadProfileData() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–¥—Ä–µ—Å–∞
                await loadUserAddresses();
                displayAddresses();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤
                await loadUserOrders();
                displayOrders();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è:', error);
            }
        }

        async function loadUserOrders() {
            try {
                if (!currentUser) return;
                
                const response = await fetch(`/orders/user/${currentUser.telegram_id}`);
                if (response.ok) {
                    userOrders = await response.json();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', response.status);
                    userOrders = [];
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', error);
                userOrders = [];
            }
        }

        function displayAddresses() {
            const container = document.getElementById('addresses-list');
            
            if (userAddresses.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–ê–¥—Ä–µ—Å–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>';
                return;
            }
            
            container.innerHTML = userAddresses.map(address => `
                <div class="address-card ${address.is_default ? 'default' : ''}">
                    ${address.is_default ? '<div class="address-badge">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>' : ''}
                    <div class="address-name">${address.name}</div>
                    <div class="address-details">
                        üìç ${address.full_address}<br>
                        ${address.entrance ? `üö™ –ü–æ–¥—ä–µ–∑–¥: ${address.entrance}<br>` : ''}
                        ${address.floor ? `üè¢ –≠—Ç–∞–∂: ${address.floor}<br>` : ''}
                        ${address.apartment ? `üè† –ö–≤–∞—Ä—Ç–∏—Ä–∞: ${address.apartment}<br>` : ''}
                        ${address.intercom ? `üìû –î–æ–º–æ—Ñ–æ–Ω: ${address.intercom}<br>` : ''}
                        ${address.comment ? `üí¨ ${address.comment}` : ''}
                    </div>
                    <div class="address-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editAddress(${address.id})">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                        <button class="btn btn-sm btn-outline" onclick="deleteAddress(${address.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        ${!address.is_default ? `<button class="btn btn-sm btn-primary" onclick="setDefaultAddress(${address.id})">‚≠ê –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function displayOrders() {
            const container = document.getElementById('orders-list');
            
            if (userOrders.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">–ó–∞–∫–∞–∑—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>';
                return;
            }
            
            container.innerHTML = userOrders.map(order => {
                const statusClass = getOrderStatusClass(order.status);
                const statusText = getOrderStatusText(order.status);
                const items = parseOrderItems(order.items);
                const orderDate = new Date(order.created_at).toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <div class="order-number">–ó–∞–∫–∞–∑ #${order.id}</div>
                                <div class="order-date">${orderDate}</div>
                            </div>
                            <div class="order-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="order-items">
                            ${items.slice(0, 3).map(item => `‚Ä¢ ${item.name} x${item.quantity}`).join('<br>')}
                            ${items.length > 3 ? `<br>... –∏ –µ—â–µ ${items.length - 3} —Ç–æ–≤–∞—Ä(–æ–≤)` : ''}
                        </div>
                        <div class="order-total">–ò—Ç–æ–≥–æ: ${order.total} ‚ÇΩ</div>
                    </div>
                `;
            }).join('');
        }

        function parseOrderItems(itemsString) {
            try {
                return JSON.parse(itemsString || '[]');
            } catch (e) {
                return [];
            }
        }

        function getOrderStatusClass(status) {
            const statusMap = {
                'pending': 'pending',
                'in_process': 'in-process', 
                'delivered': 'delivered',
                'cancelled': 'cancelled'
            };
            return statusMap[status] || 'pending';
        }

        function getOrderStatusText(status) {
            const statusMap = {
                'pending': '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
                'in_process': '–ì–æ—Ç–æ–≤–∏—Ç—Å—è',
                'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω',
                'cancelled': '–û—Ç–º–µ–Ω–µ–Ω'
            };
            return statusMap[status] || '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ';
        }

        // ===============================
        // –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ê–î–†–ï–°–ê–ú–ò
        // ===============================

        function showAddAddressForm() {
            document.getElementById('address-modal').classList.add('active');
            clearAddressForm();
        }

        function closeAddressModal() {
            document.getElementById('address-modal').classList.remove('active');
        }

        function clearAddressForm() {
            document.getElementById('address-name').value = '';
            document.getElementById('address-full').value = '';
            document.getElementById('address-city').value = '';
            document.getElementById('address-street').value = '';
            document.getElementById('address-house').value = '';
            document.getElementById('address-building').value = '';
            document.getElementById('address-entrance').value = '';
            document.getElementById('address-floor').value = '';
            document.getElementById('address-apartment').value = '';
            document.getElementById('address-intercom').value = '';
            document.getElementById('address-comment').value = '';
            document.getElementById('address-default').checked = false;
        }

        async function requestLocationForAddress() {
            try {
                
                const position = await getCurrentPosition();
                
                // –ì–µ–æ–∫–æ–¥–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                const response = await fetch('/addresses/geocode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    })
                });
                
                if (response.ok) {
                    const addressData = await response.json();
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ –∞–¥—Ä–µ—Å–∞
                    document.getElementById('address-full').value = addressData.full_address;
                    
                    // –ü–∞—Ä—Å–∏–º –∞–¥—Ä–µ—Å –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
                    parseAndFillAddressFields(addressData.full_address);
                    
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è');
                }
                
            } catch (error) {
                console.error(' –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –≤—Ä—É—á–Ω—É—é.');
                } else {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –≤—Ä—É—á–Ω—É—é.');
                }
            }
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ –∞–¥—Ä–µ—Å–∞ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
        function parseAndFillAddressFields(fullAddress) {
            try {
                
                // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–µ—Ä –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –∞–¥—Ä–µ—Å–æ–≤
                const addressParts = fullAddress.split(',').map(part => part.trim());
                
                // –ò—â–µ–º –≥–æ—Ä–æ–¥ (–æ–±—ã—á–Ω–æ –ø–µ—Ä–≤–æ–µ –∏–ª–∏ –≤—Ç–æ—Ä–æ–µ —Å–ª–æ–≤–æ)
                let city = '';
                let street = '';
                let house = '';
                
                for (let i = 0; i < addressParts.length; i++) {
                    const part = addressParts[i];
                    
                    // –ì–æ—Ä–æ–¥ (—Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–æ–≤–∞ —Ç–∏–ø–∞ "–≥–æ—Ä–æ–¥", –Ω–∞–∑–≤–∞–Ω–∏–µ –±–µ–∑ "—É–ª–∏—Ü–∞")
                    if (part.includes('–≥–æ—Ä–æ–¥') || part.includes('–ú–æ—Å–∫–≤–∞') || part.includes('–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥') || 
                        (i < 2 && !part.includes('—É–ª–∏—Ü–∞') && !part.includes('–ø—Ä–æ—Å–ø–µ–∫—Ç') && !part.includes('–ø–µ—Ä–µ—É–ª–æ–∫'))) {
                        if (!city) city = part;
                    }
                    
                    // –£–ª–∏—Ü–∞ (—Å–æ–¥–µ—Ä–∂–∏—Ç "—É–ª–∏—Ü–∞", "–ø—Ä–æ—Å–ø–µ–∫—Ç", "–ø–µ—Ä–µ—É–ª–æ–∫", "–±—É–ª—å–≤–∞—Ä")
                    if (part.includes('—É–ª–∏—Ü–∞') || part.includes('–ø—Ä–æ—Å–ø–µ–∫—Ç') || part.includes('–ø–µ—Ä–µ—É–ª–æ–∫') || 
                        part.includes('–±—É–ª—å–≤–∞—Ä') || part.includes('–ø–ª–æ—â–∞–¥—å') || part.includes('–Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è')) {
                        street = part;
                    }
                    
                    // –î–æ–º (—Å–æ–¥–µ—Ä–∂–∏—Ç "–¥–æ–º" –∏–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ü–∏—Ñ—Ä)
                    if (part.includes('–¥–æ–º') || /^\d/.test(part)) {
                        // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –¥–æ–º–∞
                        const houseMatch = part.match(/\d+[–∞-—è]?/i);
                        if (houseMatch) {
                            house = houseMatch[0];
                        }
                    }
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
                if (city) {
                    document.getElementById('address-city').value = city;
                }
                if (street) {
                    document.getElementById('address-street').value = street;
                }
                if (house) {
                    document.getElementById('address-house').value = house;
                }
                
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∞–¥—Ä–µ—Å–∞:', error);
            }
        }

        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 600000
                });
            });
        }

        async function saveAddress() {
            try {
                
                // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å
                const city = document.getElementById('address-city').value.trim();
                const street = document.getElementById('address-street').value.trim();
                const house = document.getElementById('address-house').value.trim();
                const building = document.getElementById('address-building').value.trim();
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –µ—Å–ª–∏ –æ–Ω –Ω–µ –±—ã–ª –∑–∞–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                let fullAddress = document.getElementById('address-full').value.trim();
                if (!fullAddress && (city || street || house)) {
                    const addressParts = [city, street, house, building].filter(Boolean);
                    fullAddress = addressParts.join(', ');
                }
                
                const addressData = {
                    name: document.getElementById('address-name').value.trim(),
                    full_address: fullAddress,
                    entrance: document.getElementById('address-entrance').value.trim(),
                    floor: document.getElementById('address-floor').value.trim(),
                    apartment: document.getElementById('address-apartment').value.trim(),
                    intercom: document.getElementById('address-intercom').value.trim(),
                    comment: document.getElementById('address-comment').value.trim(),
                    is_default: document.getElementById('address-default').checked
                };
                
                
                if (!addressData.name || !addressData.full_address) {
                    if (tg && tg.showAlert) {
                        tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å');
                    } else {
                        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å');
                    }
                    return;
                }
                
                if (!currentUser || !currentUser.telegram_id) {
                    console.error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    if (tg && tg.showAlert) {
                        tg.showAlert('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
                    } else {
                        alert('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
                    }
                    return;
                }
                
                const requestData = {
                    telegram_id: currentUser.telegram_id,
                    ...addressData
                };
                
                
                const response = await fetch('/addresses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                
                if (response.ok) {
                    const result = await response.json();
                    closeAddressModal();
                    await loadUserAddresses();
                    displayAddresses();
                    
                    if (tg && tg.showAlert) {
                        tg.showAlert('–ê–¥—Ä–µ—Å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
                    } else {
                        alert('–ê–¥—Ä–µ—Å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} - ${errorText}`);
                }
                
            } catch (error) {
                console.error(' –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞');
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞');
                }
            }
        }

        async function deleteAddress(addressId) {
            try {
                const confirmed = tg && tg.showConfirm ? 
                    await new Promise(resolve => tg.showConfirm('–£–¥–∞–ª–∏—Ç—å –∞–¥—Ä–µ—Å?', resolve)) :
                    confirm('–£–¥–∞–ª–∏—Ç—å –∞–¥—Ä–µ—Å?');
                    
                if (!confirmed) return;
                
                const response = await fetch(`/addresses/address/${addressId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadUserAddresses();
                    displayAddresses();
                    
                    if (tg && tg.showAlert) {
                        tg.showAlert('–ê–¥—Ä–µ—Å —É–¥–∞–ª–µ–Ω');
                    } else {
                        alert('–ê–¥—Ä–µ—Å —É–¥–∞–ª–µ–Ω');
                    }
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
            } catch (error) {
                console.error(' –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞');
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞');
                }
            }
        }

        async function setDefaultAddress(addressId) {
            try {
                const response = await fetch(`/addresses/address/${addressId}/default`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    await loadUserAddresses();
                    displayAddresses();
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
            } catch (error) {
                console.error(' –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–¥—Ä–µ—Å–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:', error);
            }
        }

        function editAddress(addressId) {
            // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
            if (tg && tg.showAlert) {
                tg.showAlert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥—Ä–µ—Å–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ');
            } else {
                alert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥—Ä–µ—Å–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ');
            }
        }

        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é showCategories –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        const originalShowCategories = window.showCategories;
        function showCategories() {
            if (currentView === 'products') {
                // –í–æ–∑–≤—Ä–∞—Ç –∏–∑ —Ç–æ–≤–∞—Ä–æ–≤ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                hideAllViews();
                document.getElementById('categories-view').style.display = 'block';
                currentView = 'categories';
                setActiveNavItem('nav-catalog');
            } else {
                // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É –∏–∑ –¥—Ä—É–≥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
                showCatalog();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(event) {
            console.error('JavaScript Error:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled Promise Rejection:', event.reason);
        });
        
    </script>
</body>
</html> 