#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –≤ dev –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å –∞–≤—Ç–æ—Ç–µ—Å—Ç–∞–º–∏ –∏ Git –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π
# –ê–≤—Ç–æ—Ä: DevOps —Å–∏—Å—Ç–µ–º–∞ DeliveryVLG  
# –î–∞—Ç–∞: 2025-01-15

set -e

echo "üöÄ –î–ï–ü–õ–û–ô –í DEV –û–ö–†–£–ñ–ï–ù–ò–ï"
echo "========================"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Git —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è dev
if [ -d ".git" ]; then
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Git —Å—Ç–∞—Ç—É—Å–∞..."
    
    current_branch=$(git symbolic-ref --short HEAD)
    echo "üìç –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $current_branch"
    
    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –¥–µ–ø–ª–æ–∏–º —Å main –≤ dev
    if [ "$current_branch" = "main" ]; then
        echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –î–µ–ø–ª–æ–π —Å main –≤–µ—Ç–∫–∏ –≤ dev –æ–∫—Ä—É–∂–µ–Ω–∏–µ!"
        echo "üí° –û–±—ã—á–Ω–æ dev –∏—Å–ø–æ–ª—å–∑—É–µ—Ç develop –≤–µ—Ç–∫—É"
    fi
    
    echo "‚úÖ Git —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω"
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ dev —Å–µ—Ä–≤–∏—Å–∞
echo "üîÑ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ dev —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl stop delivery-app-dev
echo "‚úÖ –°–µ—Ä–≤–∏—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install
echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"

# –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤ (–µ—Å–ª–∏ –Ω–µ --skip-tests)
if [ "$1" != "--skip-tests" ]; then
    echo "üß™ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤..."
    
    # API —Ç–µ—Å—Ç—ã
    NODE_ENV=development npm test
    if [ $? -eq 0 ]; then
        echo "‚úÖ API —Ç–µ—Å—Ç—ã: –ø—Ä–æ—à–ª–∏"
    else
        echo "‚ùå API —Ç–µ—Å—Ç—ã: –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å"
        echo "üîÑ –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å –±–µ–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
    fi
    
    # –¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    if npm run test:security > /dev/null 2>&1; then
        echo "‚úÖ –¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –ø—Ä–æ—à–ª–∏"
    else
        echo "‚ö†Ô∏è –¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏–ª–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å"
    fi
else
    echo "‚ö†Ô∏è –ê–≤—Ç–æ—Ç–µ—Å—Ç—ã –ø—Ä–æ–ø—É—â–µ–Ω—ã (--skip-tests)"
fi

# –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–∏—Å–∞
echo "üîÑ –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl start delivery-app-dev
echo "‚úÖ –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω"

# –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
echo "‚è±Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (15 —Å–µ–∫)..."
sleep 15

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏..."
if curl -s http://localhost:3001/health > /dev/null; then
    echo "‚úÖ Dev —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç: http://localhost:3001"
else
    echo "‚ö†Ô∏è Dev —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ health check"
    echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: sudo journalctl -fu delivery-app-dev"
fi

# Git commit hook –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
if [ -d ".git" ] && [ -n "$(git status --porcelain)" ]; then
    echo ""
    echo "üí° –£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:"
    git status --short
    echo "üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å commit –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
fi

echo ""
echo "üéâ –î–ï–ü–õ–û–ô –í DEV –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!"
echo "üåê URL: http://localhost:3001"
echo "üìä –õ–æ–≥–∏: sudo journalctl -fu delivery-app-dev"
echo "" 