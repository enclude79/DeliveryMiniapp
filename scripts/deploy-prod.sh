#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ Git –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π
# –ê–≤—Ç–æ—Ä: DevOps —Å–∏—Å—Ç–µ–º–∞ DeliveryVLG
# –î–∞—Ç–∞: 2025-01-15

set -e

echo "üè≠ –î–ï–ü–õ–û–ô –í –ü–†–û–î–ê–ö–®–ù"
echo "==================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Git —Å—Ç–∞—Ç—É—Å–∞
if [ -d ".git" ]; then
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Git —Å—Ç–∞—Ç—É—Å–∞..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –Ω–∞ main –≤–µ—Ç–∫–µ
    current_branch=$(git symbolic-ref --short HEAD)
    if [ "$current_branch" != "main" ]; then
        echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í—ã –Ω–µ –Ω–∞ main –≤–µ—Ç–∫–µ! (—Ç–µ–∫—É—â–∞—è: $current_branch)"
        echo "üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è: git checkout main"
        if [ "$1" != "--force" ]; then
            echo "‚ùå –î–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --force –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è."
            exit 1
        fi
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç uncommitted –∏–∑–º–µ–Ω–µ–Ω–∏–π
    if [ -n "$(git status --porcelain)" ]; then
        echo "‚ö†Ô∏è  –ï—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è!"
        git status --short
        if [ "$1" != "--force" ]; then
            echo "‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π—Ç–µ commit. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ --force."
            exit 1
        fi
    fi
    
    echo "‚úÖ Git —Å—Ç–∞—Ç—É—Å: OK"
fi

# –°–æ–∑–¥–∞–Ω–∏–µ backup
BACKUP_FILE="delivery-app-backup-$(date +%Y%m%d-%H%M).tar.gz"
echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."

tar -czf "$BACKUP_FILE" \
    --exclude="node_modules" \
    --exclude="*.log" \
    --exclude=".git" \
    .

echo "‚úÖ Backup —Å–æ–∑–¥–∞–Ω: $BACKUP_FILE ($(du -h $BACKUP_FILE | cut -f1))"

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è (–µ—Å–ª–∏ –Ω–µ --force)
if [ "$1" != "--force" ]; then
    echo ""
    echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –î–µ–ø–ª–æ–π –≤ –ü–†–û–î–ê–ö–®–ù!"
    echo "üè≠ –°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
    echo "üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
    echo ""
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå –î–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
        exit 1
    fi
fi

# –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
echo "üß™ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã..."
NODE_ENV=production npm test

if [ $? -ne 0 ]; then
    echo "‚ùå –¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏! –î–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω–µ–Ω."
    exit 1
fi

echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ"

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–∏—Å–∞
echo "üîÑ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl stop delivery-app
echo "‚úÖ –°–µ—Ä–≤–∏—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (graceful shutdown)"

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∫—à–Ω –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∫—à–Ω –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
npm install --production
echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–∏—Å–∞
echo "üîÑ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl start delivery-app

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
echo "‚è±Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (15 —Å–µ–∫)..."
sleep 15

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
echo "‚è±Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏..."
if curl -s http://localhost:3000/health > /dev/null; then
    echo "‚úÖ –ü—Ä–æ–¥–∞–∫—à–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç: http://localhost:3000"
else
    echo "‚ùå –ü—Ä–æ–¥–∞–∫—à–Ω –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
    echo "   sudo journalctl -fu delivery-app"
    exit 1
fi

# Git tag –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
if [ -d ".git" ] && [ "$1" != "--no-tag" ]; then
    echo "üè∑Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ Git —Ç–µ–≥–∞..."
    timestamp=$(date +%Y%m%d-%H%M)
    git tag -a "deploy-prod-$timestamp" -m "Production deploy $timestamp"
    echo "‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ–≥: deploy-prod-$timestamp"
fi

echo ""
echo "üéâ –î–ï–ü–õ–û–ô –í –ü–†–û–î–ê–ö–®–ù –ó–ê–í–ï–†–®–ï–ù!"
echo "üíæ Backup: $BACKUP_FILE"
echo "üåê URL: http://localhost:3000"
echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: sudo journalctl -fu delivery-app"
echo "" 